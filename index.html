<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Suggestion</title>
    <!-- ... Your existing CSS here ... -->
</head>
<body>
    <!-- ... Your existing HTML here ... -->
    <audio id="swoosh-sound" src="Swoosh.mp3"></audio>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const API_KEY = 'c3fd81ffd17a72709195d6fbb779b268'; // Your TMDb API key
        const GENRES_URL = `https://api.themoviedb.org/3/genre/movie/list?api_key=${API_KEY}`;

        $(document).ready(function() {
            let isFreestyle = false;

            // Fetch genres
            $.getJSON(GENRES_URL)
                .done(function(data) {
                    const genres = data.genres;
                    const genreSelect = $('#genre-select');
                    genres.forEach(genre => {
                        genreSelect.append(`<option value="${genre.id}">${genre.name}</option>`);
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching genres:', textStatus, errorThrown);
                    alert('Failed to fetch genre data. Please check the console for more details.');
                });

            $('#suggest-button').on('click', function() {
                $('#loading').show();
                const selectedGenre = $('#genre-select').val();
                const selectedDecade = $('#decade-select').val();
                
                let apiUrl = `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&sort_by=popularity.desc`;

                if (selectedGenre) {
                    apiUrl += `&with_genres=${selectedGenre}`;
                }

                if (selectedDecade) {
                    const [startYear, endYear] = selectedDecade.split('-');
                    apiUrl += `&primary_release_date.gte=${startYear}-01-01&primary_release_date.lte=${endYear}-12-31`;
                }

                // Always use page 1 for consistency, but include randomness in the seed parameter if needed
                apiUrl += '&page=1';

                $.getJSON(apiUrl)
                    .done(function(data) {
                        if (data.results.length > 0) {
                            // Now we select a random movie from the first page
                            const randomMovie = data.results[Math.floor(Math.random() * data.results.length)];
                            const movieId = randomMovie.id;
                            const posterUrl = `https://image.tmdb.org/t/p/w500${randomMovie.poster_path}`;
                            const overview = randomMovie.overview;

                            $('#pre-movie').hide();
                            $('#movie-list').show();
                            $('#movie-list').empty();
                            $('#movie-list').append(`
                                <button id="back-button">Back to Selection</button>
                                <div class="movie-item">
                                    <img src="${posterUrl}" alt="${randomMovie.title} Poster">
                                    <p>${overview || 'No synopsis available.'}</p>
                                    <div class="details">
                                        <button class="trailer-button" data-id="${movieId}">Watch Trailer</button>
                                    </div>
                                </div>
                            `);

                            $('#swoosh-sound')[0].play();
                        } else {
                            alert('No movies found for the selected criteria.');
                        }
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching data:', textStatus, errorThrown);
                        alert('Failed to fetch movie data. Please check the console for more details.');
                    })
                    .always(function() {
                        $('#loading').hide();
                    });
            });

            $('#movie-list').on('click', '.movie-item img', function() {
                if (isFreestyle) {
                    $(this).parent().toggleClass('show-details');
                }
            });

            $('#movie-list').on('click', '.trailer-button', function() {
                const movieId = $(this).data('id');
                $.getJSON(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}`, function(videoData) {
                    const trailer = videoData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
                    const trailerUrl = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : '';

                    if (trailerUrl) {
                        window.open(trailerUrl, '_blank');
                    } else {
                        alert('No trailer available.');
                    }
                });
            });

            $('#freestyle-toggle').on('click', function() {
                isFreestyle = !isFreestyle;
                $('#movie-list').toggleClass('freestyle', isFreestyle);
                $(this).text(isFreestyle ? 'Disable Freestyle' : 'Enable Freestyle');
            });

            $('#movie-list').on('click', '#back-button', function() {
                $('#movie-list').hide();
                $('#pre-movie').show();
            });
        });
    </script>
</body>
</html>
